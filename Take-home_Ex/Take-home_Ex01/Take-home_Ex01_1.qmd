---
title: "Take-home Exercise 1 Part I - Creating Data Visualisation Beyond Default"
author: "Alicia Loh"
date-modified: last-modified
execute: 
  eval: true
  echo: true
  warning: false
---

![](images/clipboard-3122103337.png){width="700"}

# **Context**

There are two major residential property market in Singapore, namely public and private housing. Public housing aims to meet the basic need of the general public with monthly household income less than or equal to S\$14,000. For families with monthly household income more than S\$14,000, they need to turn to the private residential market.

# **The Task**

Assuming the role of a graphical editor of a median company, a minimum two and maximum three of data visualisations are prepared to reveal the private residential market and sub-markets of Singapore for the 1st quarter of 2024.

# **The Data**

![](images/clipboard-3619198007.png){width="177"}

To accomplish the task, transaction data of [REALIS](https://www.ura.gov.sg/reis/index) will be used.

## Downloading the Dataset

1.  Access Dataset via [**SMU e-library**](https://www-ura-gov-sg.libproxy.smu.edu.sg/reis/ipLoginNotice)\
    [![](images/clipboard-1634732179.png)](images/clipboard-1634732179.png)

2.  After logging in with SMU credentials, navigate to "**Residential**" tab\
    [![](images/clipboard-3969337604.png)](images/clipboard-3969337604.png)

3.  Under **Property Types**, "Select All"

4.  Under **Sale Date**, select "2023 Jan" - "2024 Mar"

5.  Click "Search"

6.  Click "Download"

7.  Due to the size of the dataset, it is split into multiple segments. Download all in .csv format\
    [![](images/clipboard-2283550883.png)](images/clipboard-2283550883.png)

## **The Designing Tool**

The data will be processed using the appropriate **tidyverse** family of packages and the statistical graphics will be prepared using **ggplot2** and its extensions.

# Getting Started

## Installing and loading the required libraries

Note: Ensure that the [pacman](https://cran.r-project.org/web/packages/pacman/) package has already been installed.

The code chunk below uses `p_load()` of pacman package to check if the listed packages are installed in the computer. If they are, then they will be launched into R. Otherwise, tidyverse will be installed and launched into R.

-   [**tidyverse**](https://www.tidyverse.org/): (i.e. readr, tidyr, [dplyr](https://dplyr.tidyverse.org/), ggplot2, [lubridate](https://lubridate.tidyverse.org/)) for performing data science tasks such as importing, tidying, and wrangling data, as well as creating graphics based on The Grammar of Graphics

-   [**reshape2**](https://seananderson.ca/2013/10/19/reshape/) for transforming data between wide and long formats

-   [**ggridges**](https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html) for creating ridgeline plots

-   [**ggdist**](https://mjskay.github.io/ggdist/) for visualising distributions and uncertainty

-   ggrepel: provides geoms for ggplot2 to repel overlapping text labels.

-   ggthemes: provides some extra themes, geoms, and scales for ‘ggplot2’.

-   hrbrthemes: provides typography-centric themes and theme components for ggplot2.

-   patchwork: preparing composite figure created using ggplot2

```{r}
pacman::p_load(tidyverse, reshape2, ggridges, ggdist,
               ggrepel, ggthemes, hrbrthemes, patchwork)
```

## Importing the Data

-   The data has been split into 5 .csv files

-   Define the path to the directory containing the CSV files.

-   Use **`list.files()`** to list all CSV files in the specified directory.

-   Loop through each CSV file, read it into a data frame using **`read_csv()`**, and store it in a list.

-   Use **`bind_rows()`** to combine all data frames in the list into a single big data frame.

```{r}
csv_directory <- "data/"
csv_files <- list.files(csv_directory, pattern = "\\.csv$", full.names = TRUE)

realis <- list()

for (file in csv_files) {
  realis[[file]] <- read_csv(file)
}
```

```{r}
realis_all <- bind_rows(realis)
```

## View Data

-   Use the **`names()`** function to print the names of the columns in the tibble data frame.
-   Use the **`glimpse()`** function to get a quick overview of the tibble data frame

::: panel-tabset
## Column Names

```{r}
col_names <- names(realis_all)
col_names
```

## Overview of Tibble Data Frame

```{r}
glimpse(realis_all)
```
:::

::: callout-note
**realis_all contains:**

-   Public and Private residential property transaction data from 1st January 2023 to 31st March 2024.

-   There are 26806 rows and 21 columns.
:::

## Data Preparation

The task only requires data from the private residential market and sub-markets of Singapore for the 1st quarter of 2024.

### Standardise Date Column Format

The "Sales Date" column is currently a *cha* type. It needs to be converted into date format.

dmy() is a function from the lubridate package that converts character strings to date format in the day-month-year (DMY) order.

Standardise Date Format and verify column type after standardisation

```{r}

realis_all$`Sale Date` <- dmy(realis_all$`Sale Date`)
class(realis_all$`Sale Date`)
```

Check data

```{r}

head(realis_all$`Sale Date`)
```

### Keep only relevant rows

Filter and keep only rows that:

-   Sales Date that occur within Q1 2024 i.e. between 01 Jan 2024 to 31 Mar 2024 inclusive.

-   Purchaser Address Indicator not equal to "HDB"

In addition, any duplicate or empty rows are also removed.

```{r}
q1_pte_raw <- realis_all %>%
    filter(`Sale Date` >= as.Date("2024-01-01") & 
          `Sale Date` <= as.Date("2024-03-31"),
          `Purchaser Address Indicator` != "HDB") %>%
    distinct() %>%
    drop_na()
```

### View Data

```{r}
glimpse(q1_pte_raw)
```

::: callout-note
**q1_pte_raw contains:**

-   Private residential property transaction data from 1st January 2024 to 31st March 2024

-   There are 3567 rows and 21 columns.
:::

### Keep only relevant columns

Not all 21 columns will be used for analysis e.g. irrelevant, contains overlapping information as another column. Only relevant columns will be kept.

Columns to drop:

-   Type of Area: Not used in analysis

-   Area (SQM): Similar information as Area (SQFT)

-   Unit Price (\$ PSM): Similar information as Unit Price (\$ PSF)

-   Nett Price (\$): Similar information as Transacted Price (\$)

-   Purchaser Address Indicator: Not used in analysis

-   Postal District and Postal Sector: Overlapping information as Postal Code

The **`select()`** function is used to choose the columns to keep. However, by prefixing the column names with a minus sign (**`-`**), the function will drop the specified columns instead.

```{r}
q1_pte <- q1_pte_raw %>%
    select(
        -`Type of Area`,
        -`Area (SQM)`,
        -`Unit Price ($ PSM)`,
        -`Nett Price($)`,
        -`Purchaser Address Indicator`,
        -`Postal District`,
        -`Postal Sector`
    )
```

### View Data

```{r}
glimpse(q1_pte)
```

::: callout-note
**q1_pte contains:**

-   Private residential property transaction data from 1st January 2024 to 31st March 2024

-   There are 3567 rows and 14 columns.
:::

# Visualisation

There are various types of Properties for Private residences.

```{r}
unique(q1_pte$`Property Type`)
```

The different types in the dataset are:

-   Condominium

-   Terrace House

-   Apartment

-   Executive Condominium

-   Semi-Detached House

-   Detached House

## Price Distribution

Create box plots for the price distribution of each private residence property type. [`geom_boxplot()`](https://ggplot2.tidyverse.org/reference/geom_boxplot.html) displays continuous value list. It visualises five summary statistics (the median, two hinges and two whiskers), and all “outlying” points individually.

Note: For better visibility, **`labels`** parameter with the function **`scales::number`**, formats the y-axis labels to include thousands separators.

::: panel-tabset
## Plot

```{r}
#| echo: false

box_plot <- ggplot(data = q1_pte, 
                   aes(x = `Property Type`, y = `Transacted Price ($)`)) + 
            geom_boxplot() +
            labs(title = "Box Plot of Transacted Price ($) by Property Type",
                x = "Property Type",
                y = "Transacted Price ($)") +
            scale_y_continuous(labels = scales::number) + 
            theme_gray() + theme(axis.text.x = element_text(angle = 45, 
                                                            hjust = 1,
                                                            vjust=1))
box_plot
```

## Code

```{r}
#| eval: false

box_plot <- ggplot(data = q1_pte, 
                   aes(x = `Property Type`, y = `Transacted Price ($)`)) + 
            geom_boxplot() +
            labs(title = "Box Plot of Transacted Price ($) by Property Type",
                x = "Property Type",
                y = "Transacted Price ($)") +
            scale_y_continuous(labels = scales::number) + 
            theme_gray() + theme(axis.text.x = element_text(angle = 45, 
                                                            hjust = 1,
                                                            vjust=1))
box_plot

```
:::

::: callout-tip
There are six private property types in the dataset.

The boxplot shows Detached Houses generally have the highest transacted prices. The Q1, median, and Q3 values for this property type are all substantially higher than those of other types, indicating its premium market status. Detached Houses also exhibit the highest variability in transacted prices, although there are relatively few outliers.

In contrast, both Executive Condominiums and Terrace Houses demonstrate the least variability in transacted prices, with their interquartile ranges (IQR) closely aligning with their medians. This suggests a stable and consistent pricing trend for these property types.

Executive Condominiums have the lowest transacted prices, indicating their appeal as an affordable option within the private housing market.

Apartments and Condominiums, on the other hand, show a significant number of outliers in their transacted prices, suggesting a wider range of pricing and potentially more diversity in market conditions for these property types.
:::

## Geographical Distribution

A choropleth map is used to visualize property sales and prices across different districts or areas in Singapore. This can reveal hotspots of activity and areas with higher or lower average prices.

Two data sets will be used to create the choropleth map. They are:

-   MPSZ-2019: This data provides the sub-zone boundary of URA Master Plan 2019. It can be downloaded at [data.gov.sg](https://data.gov.sg/) It consists of the geographical boundary of Singapore at the planning subzone level. The data is based on URA Master Plan 2019.

-   Private residential property transaction data from 1st January 2024 to 31st March 2024 in tibble data frame (i.e. `q1_pte`).

The code chunk below loads the following packages:

-   tmap: for thematic mapping

-   sf: for geospatial data handling

-   httr:

```{r}
pacman::p_load(tmap,sf,httr, purrr, future, furrr)
```

### Geospatial Data

|                                      |                                      |
|----------------|----------------|
| ![](images/clipboard-3052492118.png) | ![](images/clipboard-3082063216.png) |

### **Geocoding using Singapore Land Authority (SLA) API**

Geocoding - provide geographical coordinates corresponding to a location.

Parallel processing is set up to speed up the process. Results are saved into a .csv file for easy future access.

```{r}

plan(multisession)

url <- "https://www.onemap.gov.sg/api/common/elastic/search"

postcodes <- unique(q1_pte$`Postal Code`)

# Function to fetch data for a single postal code
fetch_postcode_data <- function(postcode) {
    query <- list('searchVal' = postcode, 'returnGeom' = 'Y', 'getAddrDetails' = 'Y', 'pageNum' = '1')
    res <- GET(url, query = query)
    
    if (http_error(res)) {
        return(NULL) 
    }
    
    content_res <- content(res)
    if (content_res$found != 0) {
        return(data.frame(content_res)[4:13])
    } else {
        return(data.frame(postcode = postcode))
    }
}

results <- future_map(postcodes, fetch_postcode_data)

found <- bind_rows(results, .id = "postcode")

found <- found %>%
    filter(!is.na(postcode))

write.csv(found, file = "data/aspatial/found.csv")
```

### Import Geospatial Data

The code chunk below uses the *st_read()* function of **sf** package to import `MPSZ-2019` shapefile into R as a simple feature data frame called `mpsz`.

::: panel-tabset
## Code

```{r}
#| eval: false
mpsz <- st_read(dsn = "data/geospatial",
                layer = "MPSZ-2019") %>%
  st_transform(crs = 3414)
```

## Content

```{r}
#| echo: false
mpsz <- st_read(dsn = "data/geospatial",
                layer = "MPSZ-2019") %>%
  st_transform(crs = 3414)
```
:::

Add coordinates to q1_pte

```{r}
q1_pte_coor <- q1_pte %>%
    left_join(
        found %>% select(results.POSTAL, results.LATITUDE, results.LONGITUDE),
        by = c("Postal Code" = "results.POSTAL")
    ) %>%
    rename(
        Latitude = results.LATITUDE,
        Longitude = results.LONGITUDE
    ) %>%
   filter(!is.na(Longitude) & !is.na(Latitude))
```

### **Converting an aspatial data into a simple features tibble data frame**

```{r}
q1_pte_sf <- st_as_sf(q1_pte_coor,
                       coords = c("Longitude", "Latitude"),
                       crs =4326) %>%
  st_transform(crs = 3414)
```

### **Plotting a point simple feature layer**

```{r}
tmap_mode("view")

tm_shape(q1_pte_sf) +
  tm_dots() +
tm_view(set.zoom.limits = c(11,14))

tmap_mode("plot")
```

do i need to drop irrelevant columns for this to work?
