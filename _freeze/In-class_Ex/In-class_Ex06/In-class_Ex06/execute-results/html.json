{
  "hash": "14123f6679f1f9ba9c5c85b388016c0a",
  "result": {
    "markdown": "---\ntitle: \"In-Class Exercise 6 - \"\nauthor: \"Alicia Loh\"\ndate: \"18 May, 2024\"\ndate-modified: last-modified\nexecute: \n  eval: true\n  echo: true\n  warning: false\n  freeze: true\n---\n\n\n# Getting Started\n\n## Installing and loading the required libraries\n\nThe following R packages will be used:\n\n-   corporaexplorer\n\n-   stringi\n\n-   rvest\n\n-   readtext\n\n-   tidyverse\n\nCode chunk below will be used to check if these packages have been installed and also will load them into the working R environment.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(corporaexplorer, stringi, rvest, readtext, tidyverse)\n```\n:::\n\n\n## **The Data**\n\nDownloading the King James Bible from Project Gutenberg:\n\n### **Importing data**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbible <- readr::read_lines(\"http://www.gutenberg.org/cache/epub/10/pg10.txt\")\n```\n:::\n\n\n### Collapse into a string\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbible <- paste(bible, collapse = \"\\n\")\n```\n:::\n\n\n### **Identify the beginning and end of the Bible**\n\nTechnique borrowed from <https://quanteda.io/articles/pkgdown/replication/digital-humanities.html>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nstart_v <- stri_locate_first_fixed(bible, \"The First Book of Moses: Called Genesis\")[1]\nend_v <- stri_locate_last_fixed(bible, \"Amen.\")[2]\nbible <- stri_sub(bible, start_v, end_v)\n```\n:::\n\n\n### **Split string into books**\n\nEvery book in the bible is preceded by five newlines, which can be used to split the string into a vector where each element is a book.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbooks <- stri_split_regex(bible, \"\\n{5}\") %>%\n    unlist %>%\n    .[-40]  \n# Removing the heading \"The New Testament of the King James Bible\"\n```\n:::\n\n\n### **Replacing newlines and space**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbooks <- str_replace_all(books, \"\\n{2,}\", \"NEW_PARAGRAPH\") %>%\n    str_replace_all(\"\\n\", \" \") %>%\n    str_replace_all(\"NEW_PARAGRAPH\", \"\\n\\n\")\nbooks <- books[3:68]  # The two first elements are not books\n```\n:::\n\n\n### **Identifying chapters within books**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchapters <- str_replace_all(books, \"(\\\\d+:1 )\", \"NEW_CHAPTER\\\\1\") %>%\n    stri_split_regex(\"NEW_CHAPTER\")\n```\n:::\n\n\n### **Remove chapter headings**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchapters <- lapply(chapters, function(x) x[-1])\n```\n:::\n\n\n### **Retrieve shorter book titles**\n\nRetrieve shorter book titles from esv.org to save space in the corpus map plot.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbook_titles <- read_html(\"https://www.esv.org/resources/esv-global-study-bible/list-of-abbreviations\") %>%\n  html_nodes(\"td:nth-child(1)\") %>%\n  html_text() %>%\n  .[13:78]  # Removing irrelevant elements after manual inspection.\n```\n:::\n\n\n### Identify belonging of book\n\nIndicate whether a book belongs to the Old or New Testament.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntestament <- c(rep(\"Old\", 39), rep(\"New\", 27))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Data frame with one book as one row.\nbible_df <- tibble::tibble(Text = chapters,\n                           Book = book_titles,\n                           Testament = testament)\n\n# Each chapter to be one row, but keep the metadata (which book and which testament).\nbible_df <- tidyr::unnest(bible_df, Text)\n```\n:::\n\n\n### **Organise Data**\n\nCorpus not organised by date, so `date_based_corpus` to `FALSE`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nKJB <- prepare_data(dataset = bible_df,\n                    date_based_corpus = FALSE,\n                    grouping_variable = \"Book\",\n                    columns_doc_info = c(\"Testament\", \"Book\"))\n```\n:::\n\n\n## **Explore Corpus**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexplore(KJB)\n```\n\n::: {.cell-output-display}\n`<div style=\"width: 100% ; height: 400px ; text-align: center; box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box;\" class=\"muted well\">Shiny applications not supported in static R Markdown documents</div>`{=html}\n:::\n:::\n\n\n# Getting Started\n\n## Installing and loading the required libraries\n\nThe following R packages will be used:\n\n-   ggforce\n\n-   tidygraph\n\n-   ggraph\n\n-   visNetwork\n\n-   skimr\n\n-   tidytext\n\n-   tidyverse\n\n-   graphlayouts\n\n-   jsonlite\n\nCode chunk below will be used to check if these packages have been installed and also will load them into the working R environment.\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(ggforce, tidygraph, ggraph, \n               visNetwork, skimr, tidytext,\n               tidyverse, graphlayouts, jsonlite)\n```\n:::\n\n\n## **Importing JSON File**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc3_data <- fromJSON(\"data/MC3.json\")\n```\n:::\n\n\nVerify data type\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclass(mc3_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"list\"\n```\n:::\n:::\n\n\n## Extract edges\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc3_edges <-\n  as_tibble(mc3_data$links) %>%\n  distinct() %>%\n  mutate(source =\n           as.character(source),\n         target =\n           as.character(target),\n         type = as.character(type)) %>%\n  group_by(source,target,type) %>% #to count number of unique links\n  summarise(weights = n()) %>%\n  filter(source!=target) %>%\n  ungroup()\n```\n:::\n\n\n## Extract nodes\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc3_nodes <-\n  as_tibble(mc3_data$nodes) %>%\n  mutate(country = as.character(country),\n         id = as.character(id),\n         product_services = as.character(product_services),\n         revenue_omu = as.numeric(as.character(revenue_omu)),\n         type = as.character(type)) %>%\n  select(id, country, type, revenue_omu, product_services)\n```\n:::\n\n\n### **Modifying network nodes and edges**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nid1 <- mc3_edges %>%\n  select(source) %>%\n  rename(id = source)\n\nid2 <- mc3_edges %>%\n  select(target) %>%\n  rename (id = target)\nmc3_nodes1 <- rbind(id1, id2) %>%\n  distinct() %>%\n  left_join(mc3_nodes,\n            unmatched = \"drop\")\n```\n:::\n\n\n### **Constructing graph**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc3_graph <- tbl_graph(nodes = mc3_nodes1,\n                       edges = mc3_edges,\n                       directed = FALSE) %>%\n  mutate(betweeness_centrality = \n           centrality_betweenness(),\n         closeness_centrality = \n           centrality_closeness())\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmc3_graph\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tbl_graph: 37324 nodes and 24036 edges\n#\n# A bipartite simple graph with 13330 components\n#\n# Node Data: 37,324 × 7 (active)\n   id           country type  revenue_omu product_services betweeness_centrality\n   <chr>        <chr>   <chr>       <dbl> <chr>                            <dbl>\n 1 1 AS Marine… Islian… Comp…         NA  Scrapbook embel…                  6626\n 2 1 Ltd. Liab… Mawand… Comp…         NA  Unknown                              0\n 3 1 S.A. de C… Oceanus Comp…         NA  Unknown                              0\n 4 1 and Sagl … Kondan… Comp…      18529. Total logistics…                     1\n 5 2 Limited L… Marebak Comp…         NA  Canning, proces…                     6\n 6 2 Limited L… Marebak Comp…         NA  Unknown                              0\n 7 2 S.A. de C… Oceanus Comp…      12567. Unknown                              0\n 8 3 Coast Sp … Puerto… Comp…         NA  Unknown                              0\n 9 3 Limited L… Oceanus Comp…      26867. Fibres, yarns, …                     0\n10 3 Ltd. Liab… Oceanus Comp…     112667. European specia…                     0\n# ℹ 37,314 more rows\n# ℹ 1 more variable: closeness_centrality <dbl>\n#\n# Edge Data: 24,036 × 4\n   from    to type             weights\n  <int> <int> <chr>              <int>\n1     1 16060 Company Contacts       1\n2     1 16061 Beneficial Owner       1\n3     2 16062 Beneficial Owner       1\n# ℹ 24,033 more rows\n```\n:::\n:::\n\n\n## Graph Visualisation\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmc3_graph %>%\n  filter(betweeness_centrality >= 300000) %>%\n  ggraph(layout = \"fr\") +\n  geom_edge_link(aes(alpha = 0.5)) +\n  geom_node_point(aes(\n    size = betweeness_centrality,\n    color = \"lightblue\",\n    alpha = 0.5)) +\n  scale_size_continuous(range=c(1,10)) +\n  theme_graph()\n```\n\n::: {.cell-output-display}\n![](In-class_Ex06_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "In-class_Ex06_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}